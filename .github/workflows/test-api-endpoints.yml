name: Test API Endpoints

on:
  push:
    branches: [ main ]
    paths:
      - 'functions/**'
      - 'test_api_endpoints.py'
      - 'test_detailed_api.py'
  pull_request:
    branches: [ main ]
    paths:
      - 'functions/**'
      - 'test_api_endpoints.py'
      - 'test_detailed_api.py'
  workflow_dispatch:

env:
  PROJECT_ID: price-comparison-app-463007
  REGION: asia-northeast1
  BASE_URL: https://asia-northeast1-price-comparison-app-463007.cloudfunctions.net

jobs:
  test-api-endpoints:
    name: Test API Endpoints
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    - name: Wait for Cloud Functions to be ready
      run: |
        echo "â³ Waiting for Cloud Functions to be ready..."
        sleep 30
        
        # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã§Cloud FunctionsãŒæº–å‚™ã§ãã¦ã„ã‚‹ã‹ç¢ºèª
        for i in {1..10}; do
          echo "Attempt $i/10: Checking health endpoint..."
          if curl -f "$BASE_URL/health" > /dev/null 2>&1; then
            echo "âœ… Cloud Functions are ready!"
            break
          else
            echo "âš ï¸ Cloud Functions not ready yet, waiting 10 seconds..."
            sleep 10
          fi
          
          if [ $i -eq 10 ]; then
            echo "âŒ Cloud Functions failed to become ready after 10 attempts"
            exit 1
          fi
        done

    - name: Run Basic API Tests
      run: |
        echo "ğŸ§ª Running basic API endpoint tests..."
        python test_api_endpoints.py

    - name: Run Detailed API Tests
      run: |
        echo "ğŸ” Running detailed API tests..."
        python test_detailed_api.py

    - name: Test iPhone 17 Series Data
      run: |
        echo "ğŸ“± Testing iPhone 17 series data availability..."
        
        # iPhone 17ã‚·ãƒªãƒ¼ã‚ºã®ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãå–å¾—ã§ãã‚‹ã‹ãƒ†ã‚¹ãƒˆ
        python -c "
        import requests
        import json
        
        base_url = '$BASE_URL'
        
        # ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ã®ãƒ†ã‚¹ãƒˆ
        print('Testing get_prices endpoint...')
        response = requests.get(f'{base_url}/get_prices', params={'series': 'iPhone 17'})
        if response.status_code == 200:
            data = response.json()
            print(f'âœ… get_prices: Found {len(data)} records for iPhone 17')
            
            # iPhone 17ã‚·ãƒªãƒ¼ã‚ºãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            has_iphone17 = any('iPhone 17' in str(record) for record in data)
            if has_iphone17:
                print('âœ… iPhone 17 series found in price data')
            else:
                print('âŒ iPhone 17 series not found in price data')
                exit(1)
        else:
            print(f'âŒ get_prices failed: {response.status_code}')
            exit(1)
        
        # å…¬å¼ä¾¡æ ¼ã®ãƒ†ã‚¹ãƒˆ
        print('Testing api_prices endpoint...')
        response = requests.get(f'{base_url}/api_prices')
        if response.status_code == 200:
            data = response.json()
            print(f'âœ… api_prices: Found {len(data)} official price series')
            
            # iPhone 17ã‚·ãƒªãƒ¼ã‚ºãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if isinstance(data, list):
                iphone17_series = [item for item in data if 'iPhone 17' in str(item)]
                if iphone17_series:
                    print(f'âœ… iPhone 17 series found in official prices: {len(iphone17_series)} items')
                else:
                    print('âŒ iPhone 17 series not found in official prices')
                    exit(1)
            elif isinstance(data, dict):
                iphone17_series = [key for key in data.keys() if 'iPhone 17' in key]
                if iphone17_series:
                    print(f'âœ… iPhone 17 series found in official prices: {iphone17_series}')
                else:
                    print('âŒ iPhone 17 series not found in official prices')
                    exit(1)
            else:
                print(f'âŒ Unexpected data format: {type(data)}')
                exit(1)
        else:
            print(f'âŒ api_prices failed: {response.status_code}')
            exit(1)
        
        print('ğŸ‰ All iPhone 17 series data tests passed!')
        "

    - name: Test API Response Times
      run: |
        echo "â±ï¸ Testing API response times..."
        
        python -c "
        import requests
        import time
        
        base_url = '$BASE_URL'
        endpoints = [
            ('health', f'{base_url}/health'),
            ('api_status', f'{base_url}/api_status'),
            ('get_prices', f'{base_url}/get_prices?series=iPhone%2017'),
            ('api_prices', f'{base_url}/api_prices'),
        ]
        
        max_response_time = 5.0  # æœ€å¤§å¿œç­”æ™‚é–“ï¼ˆç§’ï¼‰
        
        for name, url in endpoints:
            start_time = time.time()
            try:
                response = requests.get(url, timeout=30)
                end_time = time.time()
                response_time = end_time - start_time
                
                if response.status_code == 200:
                    if response_time <= max_response_time:
                        print(f'âœ… {name}: {response_time:.2f}s (within {max_response_time}s limit)')
                    else:
                        print(f'âš ï¸  {name}: {response_time:.2f}s (exceeds {max_response_time}s limit)')
                else:
                    print(f'âŒ {name}: HTTP {response.status_code} in {response_time:.2f}s')
            except Exception as e:
                print(f'âŒ {name}: Error - {str(e)}')
        "

    - name: Generate Test Report
      if: always()
      run: |
        echo "ğŸ“Š Generating test report..."
        
        # ãƒ†ã‚¹ãƒˆçµæœã®ã‚µãƒãƒªãƒ¼ã‚’ä½œæˆ
        echo "## API Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Tested Endpoints" >> $GITHUB_STEP_SUMMARY
        echo "- Health Check: \`$BASE_URL/health\`" >> $GITHUB_STEP_SUMMARY
        echo "- API Status: \`$BASE_URL/api_status\`" >> $GITHUB_STEP_SUMMARY
        echo "- Get Prices: \`$BASE_URL/get_prices\`" >> $GITHUB_STEP_SUMMARY
        echo "- API Prices: \`$BASE_URL/api_prices\`" >> $GITHUB_STEP_SUMMARY
        echo "- Get Price History: \`$BASE_URL/get_price_history\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Coverage" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Basic endpoint availability" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Response format validation" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… iPhone 17 series data verification" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Response time monitoring" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Error handling validation" >> $GITHUB_STEP_SUMMARY

    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          try {
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ§ª APIãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼
              
              **ãƒ†ã‚¹ãƒˆå¯¾è±¡ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**:
              - Health Check: \`${{ env.BASE_URL }}/health\`
              - API Status: \`${{ env.BASE_URL }}/api_status\`
              - Get Prices: \`${{ env.BASE_URL }}/get_prices\`
              - API Prices: \`${{ env.BASE_URL }}/api_prices\`
              - Get Price History: \`${{ env.BASE_URL }}/get_price_history\`
              
              **ãƒ†ã‚¹ãƒˆå†…å®¹**:
              - âœ… ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å¯ç”¨æ€§ç¢ºèª
              - âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã®æ¤œè¨¼
              - âœ… iPhone 17ã‚·ãƒªãƒ¼ã‚ºãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
              - âœ… å¿œç­”æ™‚é–“ã®ç›£è¦–
              - âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ¤œè¨¼
              
              **çµæœ**: ã™ã¹ã¦ã®APIãƒ†ã‚¹ãƒˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼`
            });
            console.log('PRã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ');
          } catch (error) {
            console.log('PRã‚³ãƒ¡ãƒ³ãƒˆã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error.message);
          }
