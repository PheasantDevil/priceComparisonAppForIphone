name: Deploy to Cloud Functions

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  PROJECT_ID: price-comparison-app-463007
  REGION: asia-northeast1
  RUNTIME: python311

jobs:
  deploy-cloud-functions:
    name: Deploy Cloud Functions
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Setup Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v2

    - name: Deploy Cloud Functions
      run: |
        echo "üöÄ Deploying Cloud Functions..."
        
        # Function list
        FUNCTIONS=(
          "get_prices"
          "get_price_history"
          "api_prices"
          "api_status"
          "health"
          "scrape_prices"
          "set_alert"
          "check_prices"
        )
        
        # Deploy each function
        for func in "${FUNCTIONS[@]}"; do
          echo "üì¶ Deploying $func..."
          
          if [ -d "functions/$func" ]; then
            cd "functions/$func"
            
            if gcloud functions deploy "$func" \
              --runtime "$RUNTIME" \
              --trigger-http \
              --allow-unauthenticated \
              --entry-point "$func" \
              --region "$REGION" \
              --project "$PROJECT_ID"; then
              echo "‚úÖ $func deployed successfully"
            else
              echo "‚ùå $func deployment failed"
              exit 1
            fi
            
            cd ../..
          else
            echo "‚ö†Ô∏è Function directory functions/$func not found, skipping..."
          fi
        done
        
        echo "üéâ All Cloud Functions deployed successfully!"