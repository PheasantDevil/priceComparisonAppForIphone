name: Test Functions Changes

on:
  push:
    branches: [main]
    paths:
      - "functions/**"
  pull_request:
    branches: [main]
    paths:
      - "functions/**"
  workflow_dispatch:

env:
  PROJECT_ID: price-comparison-app-463007
  REGION: asia-northeast1
  BASE_URL: https://asia-northeast1-price-comparison-app-463007.cloudfunctions.net

jobs:
  detect-changes:
    name: Detect Function Changes
    runs-on: ubuntu-latest
    outputs:
      changed-functions: ${{ steps.changes.outputs.changed-functions }}
      has-changes: ${{ steps.changes.outputs.has-changes }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Detect changed functions
        id: changes
        run: |
          echo "ğŸ” Detecting changed functions..."

          # å¤‰æ›´ã•ã‚ŒãŸfunctionsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡º
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # PRã®å ´åˆã€ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã¨ã®å·®åˆ†ã‚’å–å¾—
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep '^functions/' || true)
          else
            # ãƒ—ãƒƒã‚·ãƒ¥ã®å ´åˆã€å‰ã®ã‚³ãƒŸãƒƒãƒˆã¨ã®å·®åˆ†ã‚’å–å¾—
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep '^functions/' || true)
          fi

          if [ -n "$CHANGED_FILES" ]; then
            echo "ğŸ“ Changed files:"
            echo "$CHANGED_FILES"
            
            # å¤‰æ›´ã•ã‚ŒãŸé–¢æ•°åã‚’æŠ½å‡º
            CHANGED_FUNCTIONS=$(echo "$CHANGED_FILES" | sed 's|functions/\([^/]*\)/.*|\1|' | sort -u | tr '\n' ' ')
            echo "ğŸ”§ Changed functions: $CHANGED_FUNCTIONS"
            
            echo "changed-functions=$CHANGED_FUNCTIONS" >> $GITHUB_OUTPUT
            echo "has-changes=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ No function files changed"
            echo "changed-functions=" >> $GITHUB_OUTPUT
            echo "has-changes=false" >> $GITHUB_OUTPUT
          fi

  test-changed-functions:
    name: Test Changed Functions
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.14"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Display changed functions
        run: |
          echo "ğŸ”§ Changed functions: ${{ needs.detect-changes.outputs.changed-functions }}"
          echo "ğŸ“‹ Testing the following functions:"
          for func in ${{ needs.detect-changes.outputs.changed-functions }}; do
            echo "  - $func"
          done

      - name: Wait for Cloud Functions to be ready
        run: |
          echo "â³ Waiting for Cloud Functions to be ready..."
          sleep 30

          # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã§Cloud FunctionsãŒæº–å‚™ã§ãã¦ã„ã‚‹ã‹ç¢ºèª
          for i in {1..10}; do
            echo "Attempt $i/10: Checking health endpoint..."
            if curl -f "$BASE_URL/health" > /dev/null 2>&1; then
              echo "âœ… Cloud Functions are ready!"
              break
            else
              echo "âš ï¸ Cloud Functions not ready yet, waiting 10 seconds..."
              sleep 10
            fi
            
            if [ $i -eq 10 ]; then
              echo "âŒ Cloud Functions failed to become ready after 10 attempts"
              exit 1
            fi
          done

      - name: Test specific changed functions
        run: |
          echo "ğŸ§ª Testing changed functions..."

          # å¤‰æ›´ã•ã‚ŒãŸé–¢æ•°ã”ã¨ã«ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
          for func in ${{ needs.detect-changes.outputs.changed-functions }}; do
            echo ""
            echo "ğŸ” Testing function: $func"
            echo "----------------------------------------"
            
            case $func in
              "health")
                echo "Testing health endpoint..."
                response=$(curl -s -w "%{http_code}" -o /dev/null "$BASE_URL/health")
                if [ "$response" = "200" ]; then
                  echo "âœ… Health endpoint: OK"
                else
                  echo "âŒ Health endpoint: HTTP $response"
                  exit 1
                fi
                ;;
                
              "api_status")
                echo "Testing api_status endpoint..."
                response=$(curl -s -w "%{http_code}" -o /dev/null "$BASE_URL/api_status")
                if [ "$response" = "200" ]; then
                  echo "âœ… API Status endpoint: OK"
                else
                  echo "âŒ API Status endpoint: HTTP $response"
                  exit 1
                fi
                ;;
                
              "get_prices")
                echo "Testing get_prices endpoint..."
                response=$(curl -s -w "%{http_code}" -o /dev/null "$BASE_URL/get_prices?series=iPhone%2017")
                if [ "$response" = "200" ]; then
                  echo "âœ… Get Prices endpoint: OK"
                else
                  echo "âŒ Get Prices endpoint: HTTP $response"
                  exit 1
                fi
                ;;
                
              "get_price_history")
                echo "Testing get_price_history endpoint..."
                response=$(curl -s -w "%{http_code}" -o /dev/null "$BASE_URL/get_price_history?series=iPhone%2017&capacity=256GB")
                if [ "$response" = "200" ]; then
                  echo "âœ… Get Price History endpoint: OK"
                else
                  echo "âŒ Get Price History endpoint: HTTP $response"
                  exit 1
                fi
                ;;
                
              "api_prices")
                echo "Testing api_prices endpoint..."
                response=$(curl -s -w "%{http_code}" -o /dev/null "$BASE_URL/api_prices")
                if [ "$response" = "200" ]; then
                  echo "âœ… API Prices endpoint: OK"
                else
                  echo "âŒ API Prices endpoint: HTTP $response"
                  exit 1
                fi
                ;;
                
              "scrape_prices")
                echo "Testing scrape_prices endpoint..."
                response=$(curl -s -w "%{http_code}" -o /dev/null "$BASE_URL/scrape_prices")
                if [ "$response" = "200" ]; then
                  echo "âœ… Scrape Prices endpoint: OK"
                else
                  echo "âŒ Scrape Prices endpoint: HTTP $response"
                  exit 1
                fi
                ;;
                
              "set_alert")
                echo "Testing set_alert endpoint..."
                response=$(curl -s -w "%{http_code}" -o /dev/null "$BASE_URL/set_alert")
                if [ "$response" = "200" ]; then
                  echo "âœ… Set Alert endpoint: OK"
                else
                  echo "âŒ Set Alert endpoint: HTTP $response"
                  exit 1
                fi
                ;;
                
              "check_prices")
                echo "Testing check_prices endpoint..."
                response=$(curl -s -w "%{http_code}" -o /dev/null "$BASE_URL/check_prices")
                if [ "$response" = "200" ]; then
                  echo "âœ… Check Prices endpoint: OK"
                else
                  echo "âŒ Check Prices endpoint: HTTP $response"
                  exit 1
                fi
                ;;
                
              *)
                echo "âš ï¸ Unknown function: $func"
                ;;
            esac
          done

          echo ""
          echo "ğŸ‰ All changed functions tested successfully!"

      - name: Run comprehensive API tests
        run: |
          echo "ğŸ” Running comprehensive API tests..."
          python test_api_endpoints.py

      - name: Generate function test report
        if: always()
        run: |
          echo "ğŸ“Š Generating function test report..."

          # ãƒ†ã‚¹ãƒˆçµæœã®ã‚µãƒãƒªãƒ¼ã‚’ä½œæˆ
          echo "## Function Change Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changed Functions" >> $GITHUB_STEP_SUMMARY
          for func in ${{ needs.detect-changes.outputs.changed-functions }}; do
            echo "- \`$func\`" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Function availability check" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… HTTP response validation" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Comprehensive API testing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Base URL" >> $GITHUB_STEP_SUMMARY
          echo "\`${{ env.BASE_URL }}\`" >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const changedFunctions = '${{ needs.detect-changes.outputs.changed-functions }}'.split(' ').filter(f => f);
              
              let functionList = '';
              if (changedFunctions.length > 0) {
                functionList = changedFunctions.map(func => `- \`${func}\``).join('\n');
              } else {
                functionList = '- No functions changed';
              }
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `ğŸ”§ Functionså¤‰æ›´ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼
                
                **å¤‰æ›´ã•ã‚ŒãŸé–¢æ•°**:
                ${functionList}
                
                **ãƒ†ã‚¹ãƒˆå†…å®¹**:
                - âœ… é–¢æ•°ã®å¯ç”¨æ€§ç¢ºèª
                - âœ… HTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹æ¤œè¨¼
                - âœ… åŒ…æ‹¬çš„ãªAPIãƒ†ã‚¹ãƒˆ
                
                **ãƒ™ãƒ¼ã‚¹URL**: \`${{ env.BASE_URL }}\`
                
                **çµæœ**: ã™ã¹ã¦ã®é–¢æ•°ãƒ†ã‚¹ãƒˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼`
              });
              console.log('PRã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ');
            } catch (error) {
              console.log('PRã‚³ãƒ¡ãƒ³ãƒˆã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error.message);
            }
