<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>iPhone 16シリーズ 買取価格比較</title>
    <style>
      /* ローディングスピナーのスタイル */
      .loader {
        border: 16px solid #f3f3f3;
        border-radius: 50%;
        border-top: 16px solid #3498db;
        width: 120px;
        height: 120px;
        animation: spin 2s linear infinite;
        margin: 20px auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      #priceTable {
        display: none;
      }

      .price-table {
        display: inline-block;
        margin: 10px;
        vertical-align: top;
        border-collapse: collapse;
      }

      .price-table caption {
        font-weight: bold;
        margin-bottom: 10px;
      }

      .price-table th, .price-table td {
        padding: 5px 10px;
        border: 1px solid #ddd;
      }

      .price-table th {
        background-color: #f2f2f2;
      }
    </style>
  </head>
  <body>
    <h1>iPhone 16シリーズ 買取価格比較</h1>

    <!-- ローディング中の表示 -->
    <div id="loading">
      <div class="loader"></div>
      <p>Loading（読み込み中）...</p>
    </div>

    <!-- エラーメッセージ表示エリア -->
    <div id="error-message" style="display: none; color: red"></div>

    <!-- 価格テーブル -->
    <div id="priceTablesContainer" style="display: none;"></div>

    <script>
      // ページが読み込まれた時に価格データを取得する
      document.addEventListener('DOMContentLoaded', function () {
        // ローディング表示
        document.getElementById('loading').style.display = 'block';
        document.getElementById('priceTablesContainer').style.display = 'none';

        // データを非同期で取得
        fetch('/get_prices')
          .then(response => response.json())
          .then(data => {
            if (data.error) {
              console.error('Error:', data.error);
              document.getElementById('loading').innerHTML = 'エラーが発生しました。詳細はコンソールを確認してください。';
            } else {
              const container = document.getElementById('priceTablesContainer');
              container.innerHTML = ''; // 既存の内容をクリア

              for (const [series, models] of Object.entries(data)) {
                const table = document.createElement('table');
                table.className = 'price-table';
                table.border = '1';
                
                // テーブルのキャプション（シリーズ名）を追加
                const caption = table.createCaption();
                caption.textContent = series;

                // ヘッダー行を作成
                const headerRow = table.insertRow();
                headerRow.innerHTML = '<th>モデル</th><th>買取価格</th>';

                // データ行を作成
                for (const [model, price] of Object.entries(models)) {
                  const row = table.insertRow();
                  row.innerHTML = `<td>${model}</td><td>${price}</td>`;
                }

                container.appendChild(table);
              }

              // ローディングを非表示にしてテーブルを表示
              document.getElementById('loading').style.display = 'none';
              document.getElementById('priceTablesContainer').style.display = 'block';
            }
          })
          .catch(error => {
            console.error('Fetch error:', error);
            document.getElementById('loading').innerHTML = 'データの取得中にエラーが発生しました。';
          });
      });

      // ブラウザ拡張機能のエラーハンドリング
      window.addEventListener('error', function (event) {
        if (event.error && event.error.message.includes('runtime.lastError')) {
          console.warn('Browser extension error:', event.error.message);
          document.getElementById('error-message').textContent =
            'ブラウザ拡張機能の動作に問題が発生しています。拡張機能を無効にしてみてください。';
          document.getElementById('error-message').style.display = 'block';
        }
      });
    </script>
  </body>
</html>
